---
title: "Smart Contracts"
description: "Comprehensive documentation of all smart contracts and their interfaces"
---

# Smart Contracts

This section provides detailed documentation of all smart contracts in the Checkpoint v2 system, including their interfaces, functions, and implementation details.

## Contract Overview

<Mermaid>
graph TB
    subgraph "Core Contracts"
        R[Registry]
        D[Deposit]
        O[Oracle]
        M[Market]
        S[Settlement]
    end
    
    subgraph "Token Contracts"
        DR[DepositReceipt NFT]
        ET[EscrowToken]
    end
    
    subgraph "Interfaces"
        IR[IRegistry]
        ID[IDeposit]
        IO[IOracle]
        IM[IMarket]
        IS[ISettlement]
    end
    
    R --> IR
    D --> ID
    O --> IO
    M --> IM
    S --> IS
    D --> DR
    M --> ET
</Mermaid>

## Registry Contract

The Registry contract manages all points programs and their configurations.

### Contract Address
```solidity
contract Registry is IRegistry, UUPSUpgradeable, Ownable2StepUpgradeable
```

### Key Functions

#### `addPoints`
Add a new points program to the registry.

```solidity
function addPoints(
    uint256 pointsId,
    string memory name,
    address escrowToken,
    address depositToken
) external onlyOwner
```

**Parameters:**
- `pointsId`: Unique identifier for the points program
- `name`: Human-readable name of the program
- `escrowToken`: Address of the escrow token contract
- `depositToken`: Address of the deposit receipt NFT contract

**Events:**
```solidity
event PointsAdded(
    uint256 indexed pointsId,
    string name,
    address escrowToken,
    address depositToken
);
```

#### `toggleDeposits`
Enable or disable deposits for a points program.

```solidity
function toggleDeposits(uint256 pointsId) external onlyOwner
```

**Events:**
```solidity
event PointsDepositsToggled(uint256 indexed pointsId, bool paused);
```

#### `enableSettlement`
Enable settlement for a points program after TGE.

```solidity
function enableSettlement(uint256 pointsId, address token, uint32 lzEid) external onlyOwner
```

**Parameters:**
- `pointsId`: Points program identifier
- `token`: Address of the public token (post-TGE)
- `lzEid`: LayerZero endpoint ID for cross-chain operations

**Events:**
```solidity
event PointsSettlementEnabled(
    uint256 indexed pointsId,
    address token,
    uint32 lzEid
);
```

#### `getPointsInfo`
Get information about a points program.

```solidity
function getPointsInfo(uint256 pointsId) external view returns (PointsInfo memory)
```

**Returns:**
```solidity
struct PointsInfo {
    string name;              // Program name
    address token;            // Public token (post-TGE)
    uint32 lzEid;            // LayerZero endpoint ID
    address escrowToken;      // Escrow token (pre-TGE)
    address depositToken;     // Deposit receipt NFT
    bool depositPaused;       // Deposit status
    bool settlementActive;    // Settlement status
}
```

### Storage Layout
Uses diamond storage pattern for upgrade safety:

```solidity
bytes32 private constant REGISTRY_STORAGE_LOCATION =
    0xbf008ed8d328e2d46f70b3236db67571f9c4c6b12304dd7ded1b7a9f10351000;
```

## Deposit Contract

The Deposit contract handles the tokenization of off-chain points into on-chain assets.

### Contract Address
```solidity
contract Deposit is IDeposit, UUPSUpgradeable, Ownable2StepUpgradeable, ReentrancyGuardUpgradeable
```

### Key Functions

#### `deposit`
Convert off-chain points into on-chain tokens.

```solidity
function deposit(
    uint256 pointsId,
    uint256 amount,
    uint256 expiry,
    bytes calldata signature
) external payable nonReentrant
```

**Parameters:**
- `pointsId`: Points program identifier
- `amount`: Amount of points to deposit
- `expiry`: Signature expiry timestamp
- `signature`: Oracle signature for verification

**Process:**
1. Verify oracle signature
2. Check points program is active
3. Mint soulbound NFT to user
4. Update deposit statistics
5. Collect deposit fee

**Events:**
```solidity
event PointsDeposited(uint256 indexed pointsId, address indexed user, uint256 amount);
```

#### `setConfig`
Configure deposit contract parameters.

```solidity
function setConfig(address feeRecipient, uint256 depositFeeNative) external onlyOwner
```

**Parameters:**
- `feeRecipient`: Address to receive deposit fees
- `depositFeeNative`: Deposit fee in wei

**Events:**
```solidity
event NewConfigSet(address feeRecipient, uint256 depositFeeNative);
```

#### `setOracle`
Update the oracle contract address.

```solidity
function setOracle(address _oracle) external onlyOwner
```

**Events:**
```solidity
event OracleSet(address indexed from, address indexed to);
```

#### `getGlobalDepositStats`
Get global deposit statistics for a points program.

```solidity
function getGlobalDepositStats(uint256 pointsId)
    external
    view
    returns (GlobalDepositStats memory)
```

**Returns:**
```solidity
struct GlobalDepositStats {
    uint256 depositedPoints;  // Total points deposited
}
```

#### `getUserDepositStats`
Get user-specific deposit statistics.

```solidity
function getUserDepositStats(uint256 pointsId, address user)
    external
    view
    returns (UserDepositStats memory)
```

**Returns:**
```solidity
struct UserDepositStats {
    uint256 depositedPoints;  // User's deposited points
}
```

### Storage Layout
Uses diamond storage pattern:

```solidity
bytes32 private constant DEPOSIT_STORAGE_LOCATION =
    0x8b64d79d4e972f115001dfe8b5a6a837c1ed7675fdc7397859d87cfc858b1b00;
```

## Oracle Contract

The Oracle contract provides cryptographic verification of off-chain claims.

### Contract Address
```solidity
contract Oracle is IOracle, UUPSUpgradeable, AccessControlUpgradeable
```

### Key Functions

#### `verifyDepositClaim`
Verify a deposit claim signature.

```solidity
function verifyDepositClaim(
    uint256 pointsId,
    address user,
    uint256 amount,
    uint256 expiry,
    bytes calldata signature
) external returns (bool)
```

**Process:**
1. Check signature expiry
2. Construct message hash
3. Verify ECDSA signature
4. Increment user nonce
5. Return verification result

#### `verifyPointsChangeClaim`
Verify a points change claim signature.

```solidity
function verifyPointsChangeClaim(
    uint256 pointsId,
    address user,
    uint256 oldAmount,
    uint256 newAmount,
    uint256 claimTime,
    uint256 expiry,
    bytes calldata signature
) external returns (bool)
```

**Process:**
1. Check signature expiry
2. Verify claim timing
3. Construct message hash
4. Verify ECDSA signature
5. Increment points change nonce

#### `verifySettlementClaim`
Verify a cross-chain settlement claim.

```solidity
function verifySettlementClaim(
    uint256 offerId,
    address user,
    uint256 chainId,
    bytes calldata txhash,
    uint256 expiry,
    bytes calldata signature
) external returns (bool)
```

**Process:**
1. Check signature expiry
2. Validate chain ID
3. Check offer not already settled
4. Construct message hash
5. Verify ECDSA signature
6. Mark offer as settled

#### `setVestingInfo`
Set vesting information for an offer.

```solidity
function setVestingInfo(
    uint256 offerId,
    bool isVesting,
    uint128 unvestedAmount,
    uint128 vestAmount,
    uint192 vestEnd,
    address receiver,
    address token,
    address sender
) external onlyRole(VESTING_MANAGER_ROLE)
```

**Events:**
```solidity
event VestingInfoSet(
    uint256 indexed offerId,
    address indexed receiver,
    address indexed sender,
    bool isVesting,
    uint256 unvestedAmount,
    uint256 vestAmount,
    uint256 vestEnd,
    address token
);
```

### Vesting Functions

#### `isVestingActive`
Check if vesting is currently active.

```solidity
function isVestingActive(uint256 offerId) external view returns (bool)
```

#### `isVestingComplete`
Check if vesting period has ended.

```solidity
function isVestingComplete(uint256 offerId) external view returns (bool)
```

#### `getVestingClaimableNow`
Get currently claimable amount.

```solidity
function getVestingClaimableNow(uint256 offerId) external view returns (uint256)
```

### Storage Layout
Uses diamond storage pattern:

```solidity
bytes32 private constant ORACLE_STORAGE_LOCATION =
    0xd14f0c4cc1e043d0c375c34b1840814fe5143cb230321e760829abcc800bdc00;
```

## Market Contract

The Market contract enables trading of tokenized points before TGE.

### Contract Address
```solidity
contract Market is IMarket, UUPSUpgradeable, ReentrancyGuardUpgradeable, AccessControlUpgradeable
```

### Key Functions

#### `createOffer`
Create a sell offer for points.

```solidity
function createOffer(
    uint256 pointsId,
    uint256 pointsAmount,
    uint256 price,
    address collateralToken,
    uint256 collateralAmount
) external returns (uint256 offerId)
```

**Process:**
1. Validate parameters
2. Check points program is active
3. Verify user has sufficient points
4. Hold points in deposit contract
5. Pull collateral from user
6. Create offer record

**Events:**
```solidity
event OfferCreated(
    uint256 indexed offerId,
    uint256 indexed pointsId,
    address indexed maker,
    address collateralToken,
    uint256 pointsAmount,
    uint256 price,
    uint256 collateralAmount
);
```

#### `fillOffer`
Fill an offer completely.

```solidity
function fillOffer(uint256 offerId) external nonReentrant
```

**Process:**
1. Validate offer is active
2. Check user is not the maker
3. Pull USDC from buyer
4. Mint escrow tokens to buyer
5. Update offer status

**Events:**
```solidity
event OfferFilled(uint256 indexed offerId, address indexed filler);
```

#### `fillOfferPartial`
Fill an offer partially.

```solidity
function fillOfferPartial(uint256 offerId, uint256 amount) external nonReentrant
```

**Process:**
1. Validate offer can be filled
2. Calculate proportional points
3. Pull USDC from buyer
4. Mint escrow tokens to buyer
5. Update offer status

**Events:**
```solidity
event OfferFilledPartial(uint256 indexed offerId, address indexed filler, uint256 amount);
```

#### `settleOffer`
Settle an offer after TGE.

```solidity
function settleOffer(uint256 offerId) external nonReentrant
```

**Process:**
1. Check settlement deadline
2. Calculate settlement fee
3. Send USDC to seller
4. Send tokens to settlement contract
5. Return collateral to seller

**Events:**
```solidity
event OfferSettled(uint256 indexed offerId);
```

#### `cancelOffer`
Cancel an offer.

```solidity
function cancelOffer(uint256 offerId) external nonReentrant
```

**Process:**
1. Check user is the maker
2. Check offer is active
3. Calculate cancellation fee
4. Return collateral to maker
5. Release held points

**Events:**
```solidity
event OfferCancelled(uint256 indexed offerId);
```

### Offer Management

#### `getOffer`
Get offer information.

```solidity
function getOffer(uint256 offerId) external view returns (Offer memory)
```

**Returns:**
```solidity
struct Offer {
    uint256 pointsId;
    address maker;
    address[] fillers;
    uint256 filledAmount;
    OfferStatus status;
    uint256 pointsAmount;
    uint256 tokenAmount;
    uint256 price;
    uint256 collateralAmount;
    address collateralToken;
    bool hasVesting;
    bool isBuyOffer;
}
```

#### `getOffersBatch`
Get multiple offers.

```solidity
function getOffersBatch(uint256[] calldata offerIds) external view returns (Offer[] memory)
```

### Configuration

#### `setConfig`
Configure market parameters.

```solidity
function setConfig(
    address feeRecipient,
    address[] memory collateralTokens,
    uint256 settlementFee,
    uint256 cancellationFee,
    uint256 overdueFee
) external onlyRole(DEFAULT_ADMIN_ROLE)
```

**Parameters:**
- `feeRecipient`: Address to receive fees
- `collateralTokens`: Supported collateral tokens
- `settlementFee`: Settlement fee in bps
- `cancellationFee`: Cancellation fee in bps
- `overdueFee`: Overdue fee in bps

### Storage Layout
Uses diamond storage pattern:

```solidity
bytes32 private constant MARKET_STORAGE_LOCATION =
    0x8585c2a21df0293deed74c3e830f4d6eaa2e7495be9ca9db86c1f5526b678b00;
```

## Settlement Contract

The Settlement contract handles token distribution after TGE.

### Contract Address
```solidity
contract Settlement is ISettlement, OAppSenderUpgradeable, UUPSUpgradeable
```

### Key Functions

#### `depositToken`
Deposit tokens for settlement.

```solidity
function depositToken(uint256 offerId, uint256 amount) external onlyMarket
```

**Process:**
1. Validate offer is filled
2. Check points program is active
3. Pull tokens from market contract

#### `settleDistribution`
Calculate distribution ratios.

```solidity
function settleDistribution(
    uint256 pointsId,
    uint256 remoteTotalTokenAmount,
    bytes32 remoteSettlement
) external onlyAfterDeadline(pointsId)
```

**Process:**
1. Get total escrow supply
2. Calculate token amount (local or remote)
3. Calculate distribution ratio
4. Collect collateral amounts

**Events:**
```solidity
event SettledDistribution(
    uint256 indexed pointsId,
    bytes32 remoteSettlement,
    uint256 totalTokenAmount,
    uint256 totalEscrowSupply,
    uint256 tokenRatio,
    uint64 timestamp
);
```

#### `claimDistribution`
Claim token distribution.

```solidity
function claimDistribution(uint256 pointsId) external onlyAfterDeadline(pointsId)
```

**Process:**
1. Check settlement is on this chain
2. Get user's escrow balance
3. Calculate token share
4. Calculate collateral share
5. Transfer tokens to user

#### `sendCollateralTokens`
Send collateral tokens to remote chain.

```solidity
function sendCollateralTokens(uint256 pointsId) external payable onlyAfterDeadline(pointsId)
```

**Process:**
1. Check settlement is not on this chain
2. Iterate through collateral tokens
3. Check slippage tolerance
4. Send tokens via LayerZero
5. Refund excess fees

**Events:**
```solidity
event SentCollateralTokens(uint256 indexed pointsId);
```

#### `sendSettlementMessage`
Send settlement message to remote chain.

```solidity
function sendSettlementMessage(uint256 pointsId) external payable
```

**Process:**
1. Check collateral has been sent
2. Create LayerZero message
3. Send message via LayerZero
4. Emit settlement event

**Events:**
```solidity
event SettlementMessageSent(uint256 indexed pointsId, bytes message);
```

### Cross-Chain Functions

#### `quoteSendSettlementMessage`
Quote cost for sending settlement message.

```solidity
function quoteSendSettlementMessage(uint256 pointsId)
    external
    view
    returns (MessagingFee memory)
```

#### `quoteSendCollateralTokens`
Quote cost for sending collateral tokens.

```solidity
function quoteSendCollateralTokens(uint256 pointsId)
    external
    view
    returns (MessagingFee memory fee)
```

### Storage Layout
Uses diamond storage pattern:

```solidity
bytes32 private constant SETTLEMENT_STORAGE_LOCATION =
    0xce8faf880dd4068ffcdef6a1ef539d22b45af4078a2ab44fea260c875c5b3800;
```

## Deposit Receipt NFT

A soulbound NFT that tracks user's deposited points.

### Contract Address
```solidity
contract DepositReceipt is IDepositReceipt, ERC721, ERC721Pausable, AccessControl
```

### Key Functions

#### `deposit`
Mint NFT and record deposit.

```solidity
function deposit(address onBehalfOf, uint256 amount)
    external
    whenNotPaused
    onlyRole(DEPOSITOR_ROLE)
```

**Process:**
1. Check user hasn't already deposited
2. Mint soulbound NFT to user
3. Record deposit amount
4. Emit deposit event

**Events:**
```solidity
event Deposit(address indexed user, uint256 amount);
```

#### `changePoints`
Update user's point balance.

```solidity
function changePoints(
    address user,
    uint128 oldAmount,
    uint128 newAmount,
    uint256 claimTime,
    uint256 expiry,
    bytes calldata signature
) external
```

**Process:**
1. Verify oracle signature
2. Update point balance
3. Record historical change
4. Emit points changed event

**Events:**
```solidity
event PointsChanged(
    address indexed user,
    uint256 claimTime,
    uint128 oldAmount,
    uint128 newAmount
);
```

#### `increaseHold`
Increase held amount for market orders.

```solidity
function increaseHold(address user, uint256 amount) external onlyRole(MARKET_ROLE)
```

**Events:**
```solidity
event IncreaseHold(address indexed user, uint256 amount, uint256 newHeldAmount);
```

#### `decreaseHold`
Decrease held amount when orders are filled.

```solidity
function decreaseHold(address user, uint256 amount) external onlyRole(MARKET_ROLE)
```

**Events:**
```solidity
event DecreaseHold(address indexed user, uint256 amount, uint256 newHeldAmount);
```

#### `getUserData`
Get user's deposit data.

```solidity
function getUserData(address user)
    external
    view
    returns (
        uint256 depositedAmount,
        uint256 heldAmount,
        int256 depositedDelta,
        uint256 lastClaimTime
    )
```

#### `getUserHistoricalPoints`
Get user's historical point changes.

```solidity
function getUserHistoricalPoints(address user)
    external
    view
    returns (Checkpoints.Checkpoint256[] memory res)
```

### Token URI
NFTs use a structured base URI:

```solidity
function _baseURI() internal view override returns (string memory) {
    return string.concat(
        "https://nft.checkpoint.exchange/",
        Strings.toString(block.chainid),
        "/",
        Strings.toString(POINTS_ID),
        ".json"
    );
}
```

## Escrow Token

An ERC20 token representing points before TGE.

### Contract Address
```solidity
contract EscrowToken is IEscrowToken, OFT, Pausable
```

### Key Functions

#### `mint`
Mint tokens to a user.

```solidity
function mint(address to, uint256 amount) external whenNotPaused onlyMarket
```

#### `burn`
Burn tokens from a user.

```solidity
function burn(address from, uint256 amount) external whenNotPaused onlyMarket
```

#### `pause`
Pause token operations.

```solidity
function pause() external onlyOwner
```

#### `unpause`
Unpause token operations.

```solidity
function unpause() external onlyOwner
```

### LayerZero Integration
The EscrowToken extends LayerZero's OFT (Omnichain Fungible Token) for cross-chain compatibility.

## Error Handling

All contracts use comprehensive error handling with specific error types:

```solidity
error InvalidOwner();
error InvalidOracle(address oracle);
error InvalidRegistry(address registry);
error InvalidToken(address token);
error InvalidSigner(address signer);
error InvalidSignature();
error DepositsPaused();
error SettlementIsActive();
error CannotFillOffer();
error CannotSettleOffer();
error CannotCancelOffer();
error AlreadyDeposited(uint256 tokenId);
error NotDeposited(uint256 tokenId);
error CannotTransfer();
```

## Security Features

### Upgradeability
All contracts use OpenZeppelin's UUPS (Universal Upgradeable Proxy Standard) for secure upgrades.

### Access Control
Role-based access control using OpenZeppelin's AccessControl for different permission levels.

### Reentrancy Protection
All external functions are protected against reentrancy attacks using ReentrancyGuard.

### Signature Verification
Cryptographic signature verification using ECDSA for all off-chain claims.

### Nonce Management
User-specific nonces prevent replay attacks on signature-based operations.

## Gas Optimization

### Diamond Storage
All contracts use diamond storage pattern for gas efficiency and upgrade safety.

### Batch Operations
Support for batch operations where possible to reduce gas costs.

### Storage Layout
Optimized storage layout to minimize gas costs for common operations.

### Event Optimization
Efficient event emission to reduce gas costs while maintaining transparency.
